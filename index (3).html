<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ù–∞–∫–ª–µ–µ–∫ v3.0 (Clean)</title>
    <style>
        :root {
            --bg-color: #eef2f5;
            --panel-bg: #ffffff;
            --text-color: #333;
            --accent-color: #3498db;
            --danger-color: #e74c3c;
            --success-color: #27ae60;
            --border-color: #dde1e6;
        }

        body {
            margin: 0; padding: 0;
            font-family: 'Segoe UI', Roboto, Helvetica, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- –õ–ï–í–ê–Ø –ü–ê–ù–ï–õ–¨ --- */
        .settings-panel {
            width: 350px;
            background: var(--panel-bg);
            border-right: 1px solid var(--border-color);
            padding: 20px;
            overflow-y: auto;
            display: flex; flex-direction: column; gap: 12px;
            box-shadow: 2px 0 15px rgba(0,0,0,0.03);
            z-index: 10;
        }

        h2 { margin: 0 0 10px 0; font-size: 1.3rem; color: #2c3e50; display: flex; align-items: center; gap: 10px; }
        h3 { font-size: 0.8rem; color: #8898aa; text-transform: uppercase; border-bottom: 2px solid #f4f5f7; padding-bottom: 6px; margin-top: 15px; letter-spacing: 0.5px; }

        .control-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 5px; }
        .control-full { width: 100%; margin-bottom: 5px; }
        
        label { display: block; font-size: 0.75rem; margin-bottom: 4px; font-weight: 600; color: #555; }
        input, select { 
            width: 100%; padding: 8px; 
            border: 1px solid #ced4da; border-radius: 6px; 
            box-sizing: border-box; font-size: 14px; 
            transition: border 0.2s;
        }
        input:focus, select:focus { border-color: var(--accent-color); outline: none; }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn {
            border: none; padding: 12px; border-radius: 8px; cursor: pointer; width: 100%; 
            font-weight: 600; font-size: 0.9rem; transition: all 0.2s ease;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:active { transform: scale(0.98); }
        .btn-add { background-color: var(--accent-color); color: white; margin-top: 10px; box-shadow: 0 4px 6px rgba(52, 152, 219, 0.2); }
        .btn-add:hover { background-color: #2980b9; }

        .btn-fill { background-color: #9b59b6; color: white; margin-top: 5px; font-size: 0.8rem; padding: 8px; }
        
        .btn-clear { background-color: #fff; border: 1px solid var(--danger-color); color: var(--danger-color); margin-top: 5px; }
        .btn-clear:hover { background-color: var(--danger-color); color: white; }

        .btn-print { background-color: var(--success-color); color: white; margin-top: auto; padding: 16px; font-size: 1.1rem; box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3); }
        .btn-print:hover { background-color: #219150; }

        /* –°–ø–∏—Å–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö */
        .added-list {
            flex: 1; min-height: 100px; max-height: 250px;
            overflow-y: auto; border: 1px solid #eee; border-radius: 8px; background: #fafafa;
        }
        .added-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; border-bottom: 1px solid #eee; font-size: 0.85rem; background: white;
        }
        .added-item:last-child { border-bottom: none; }
        .item-info { display: flex; align-items: center; gap: 8px; }
        .color-dot { width: 12px; height: 12px; border-radius: 50%; border: 1px solid #ddd; }

        /* --- –ü–†–ê–í–ê–Ø –ß–ê–°–¢–¨ (–ü–†–ï–î–ü–†–û–°–ú–û–¢–†) --- */
        .preview-area {
            flex: 1; padding: 40px;
            display: flex; justify-content: center; align-items: flex-start;
            overflow: auto; background-color: #525659; /* –¶–≤–µ—Ç –∫–∞–∫ –≤ Adobe Acrobat */
        }

        #sheet {
            width: 210mm; height: 297mm;
            background: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex; flex-wrap: wrap; align-content: flex-start; justify-content: flex-start;
            position: relative; overflow: hidden;
            box-sizing: border-box;
            transform-origin: top center;
        }

        /* –°—Ç–∏–ª—å –Ω–∞–∫–ª–µ–π–∫–∏ */
        .sticker {
            box-sizing: border-box;
            display: flex; flex-direction: column;
            overflow: hidden; position: relative;
            page-break-inside: avoid;
        }
        
        .sticker-content {
            width: 100%; height: 100%;
            display: flex; flex-direction: column;
            pointer-events: none; /* –ß—Ç–æ–±—ã —Ç–µ–∫—Å—Ç –Ω–µ –º–µ—à–∞–ª –∫–ª–∏–∫–∞–º (–Ω–∞ –±—É–¥—É—â–µ–µ) */
        }

        .sticker img {
            max-width: 100%; max-height: 100%;
            object-fit: contain; /* –ö–∞—Ä—Ç–∏–Ω–∫–∞ –≤—Å–µ–≥–¥–∞ –≤–ª–µ–∑–∞–µ—Ç —Ü–µ–ª–∏–∫–æ–º */
            display: block;
        }

        .sticker span {
            white-space: pre-wrap; /* –ü–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫ */
            line-height: 1.2;
            max-width: 100%;
        }

        /* –õ–ò–ù–ò–ò –†–ï–ó–ê (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) */
        .cut-lines .sticker {
            outline: 1px dashed #ccc;
            z-index: 1;
        }

        /* –ü–ï–†–ï–ü–û–õ–ù–ï–ù–ò–ï */
        #sheet.overflowed { border-bottom: 5px solid var(--danger-color); }
        .warning-msg {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: var(--danger-color); color: white; padding: 10px 20px;
            border-radius: 20px; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none; z-index: 100;
        }

        /* --- –ü–ï–ß–ê–¢–¨ --- */
        @media print {
            @page { size: A4; margin: 0; }
            body { background: white; display: block; height: auto; }
            .settings-panel { display: none !important; }
            .preview-area { padding: 0; background: white; display: block; overflow: visible; }
            .warning-msg { display: none !important; }
            
            #sheet { 
                box-shadow: none; margin: 0; width: 210mm; height: 297mm;
                /* –í–∞–∂–Ω–æ –¥–ª—è —Ç–æ—á–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤ –ø—Ä–∏ –ø–µ—á–∞—Ç–∏ */
                print-color-adjust: exact; 
                -webkit-print-color-adjust: exact;
            }
            
            /* –ü—Ä–∏ –ø–µ—á–∞—Ç–∏ –ª–∏–Ω–∏–∏ —Ä–µ–∑–∞ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è —Ç–æ–Ω–∫–∏–º–∏ –∏ —Å–µ—Ä—ã–º–∏, –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω—ã */
            .cut-lines .sticker { outline: 0.5px solid #bbb; }
        }
    </style>
</head>
<body>

    <div class="settings-panel">
        <h2>üõ†Ô∏è –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä v3.0</h2>
        
        <h3>1. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ª–∏—Å—Ç–∞</h3>
        <div class="control-group">
            <div><label>–ü–æ–ª—è (–º–º)</label><input type="number" id="pageMargin" value="10" min="0" onchange="renderSheet()"></div>
            <div><label>–ó–∞–∑–æ—Ä (–º–º)</label><input type="number" id="gap" value="0" min="0" onchange="renderSheet()"></div>
        </div>
        <div style="display:flex; align-items:center; gap:10px; font-size:0.8rem; margin-top:5px;">
            <input type="checkbox" id="showCutLines" style="width:auto;" onchange="toggleCutLines()" checked>
            <label for="showCutLines" style="margin:0; cursor:pointer;">–ü–æ–∫–∞–∑–∞—Ç—å –ª–∏–Ω–∏–∏ –¥–ª—è —Ä–µ–∑–∫–∏</label>
        </div>

        <h3>2. –î–∏–∑–∞–π–Ω –Ω–∞–∫–ª–µ–π–∫–∏</h3>
        <div class="control-group">
            <div><label>–®–∏—Ä–∏–Ω–∞ (–º–º)</label><input type="number" id="newWidth" value="60"></div>
            <div><label>–í—ã—Å–æ—Ç–∞ (–º–º)</label><input type="number" id="newHeight" value="40"></div>
        </div>
        
        <div class="control-full">
            <label>–¢–µ–∫—Å—Ç (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞)</label>
            <input type="text" id="newText" placeholder="">
        </div>
        
        <div class="control-group">
            <div><label>–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞</label><input type="number" id="fontSize" value="12"></div>
            <div><label>–í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ</label>
                <select id="alignment">
                    <option value="center">–ü–æ —Ü–µ–Ω—Ç—Ä—É</option>
                    <option value="flex-start">–í–≤–µ—Ä—Ö—É</option>
                    <option value="flex-end">–í–Ω–∏–∑—É</option>
                </select>
            </div>
        </div>

        <div class="control-full">
            <label>–ö–∞—Ä—Ç–∏–Ω–∫–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
            <input type="file" id="newImage" accept="image/*" style="border:none; padding-left:0;">
        </div>

        <div class="control-group" style="margin-top:5px;">
            <div><label>–¶–≤–µ—Ç —Ñ–æ–Ω–∞</label><input type="color" id="bgColor" value="#ffffff"></div>
            <div><label>–†–∞–º–∫–∞</label>
                <select id="borderStyle">
                    <option value="none">–ù–µ—Ç</option>
                    <option value="1px solid #000">–¢–æ–Ω–∫–∞—è</option>
                    <option value="2px solid #000">–ñ–∏—Ä–Ω–∞—è</option>
                </select>
            </div>
        </div>

        <h3>3. –î–µ–π—Å—Ç–≤–∏—è</h3>
        <div class="control-group">
            <div><label>–ö–æ–ª-–≤–æ</label><input type="number" id="newCount" value="1"></div>
            <button class="btn btn-add" style="margin:0; height: 36px;" onclick="addStickers()">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
        <button class="btn btn-fill" onclick="fillPage()">ü™Ñ –ó–∞–ø–æ–ª–Ω–∏—Ç—å –æ—Å—Ç–∞—Ç–æ–∫ –ª–∏—Å—Ç–∞ —ç—Ç–∏–º–∏ –Ω–∞–∫–ª–µ–π–∫–∞–º–∏</button>

        <h3>–°–æ—Å—Ç–∞–≤ –ª–∏—Å—Ç–∞</h3>
        <div class="added-list" id="logList"></div>
        <button class="btn btn-clear" onclick="clearSheet()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–∏—Å—Ç</button>

        <button class="btn btn-print" onclick="window.print()">üñ®Ô∏è –ü–µ—á–∞—Ç—å PDF</button>
    </div>

    <div class="preview-area">
        <div class="warning-msg" id="warningMsg">‚ö†Ô∏è –≠–ª–µ–º–µ–Ω—Ç—ã –Ω–µ –≤–ª–µ–∑–∞—é—Ç –Ω–∞ –æ–¥–Ω—É —Å—Ç—Ä–∞–Ω–∏—Ü—É!</div>
        <div id="sheet" class="cut-lines"></div>
    </div>

    <script>
        let stickerGroups = [];

        // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π –ø–∞—Ä—Ç–∏–∏
        function addStickers(overrideCount = null) {
            const w = parseFloat(document.getElementById('newWidth').value);
            const h = parseFloat(document.getElementById('newHeight').value);
            const count = overrideCount !== null ? overrideCount : parseInt(document.getElementById('newCount').value);
            const bg = document.getElementById('bgColor').value;
            const text = document.getElementById('newText').value;
            const fontSize = document.getElementById('fontSize').value;
            const align = document.getElementById('alignment').value;
            const border = document.getElementById('borderStyle').value;
            
            const imageInput = document.getElementById('newImage');
            
            if (!w || !h || !count) return;

            // –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª, –µ—Å–ª–∏ –µ—Å—Ç—å
            if (imageInput.files && imageInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    saveAndRender(w, h, count, bg, text, fontSize, align, border, e.target.result);
                }
                reader.readAsDataURL(imageInput.files[0]);
            } else {
                saveAndRender(w, h, count, bg, text, fontSize, align, border, null);
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞
        function saveAndRender(w, h, count, bg, text, fontSize, align, border, imgData) {
            stickerGroups.push({
                width: w, height: h, count, bg, text, fontSize, align, border, imgData
            });
            updateLog();
            renderSheet();
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª—è –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞ –∏ —Ñ–∞–π–ª–∞ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–≤–æ–¥–∞
            document.getElementById('newText').value = '';
            document.getElementById('newImage').value = ''; 
        }

        // "–£–º–Ω–æ–µ" –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        function fillPage() {
            const sheet = document.getElementById('sheet');
            const w = parseFloat(document.getElementById('newWidth').value);
            const h = parseFloat(document.getElementById('newHeight').value);
            const margin = parseFloat(document.getElementById('pageMargin').value);
            const gap = parseFloat(document.getElementById('gap').value);

            // –†–∞–∑–º–µ—Ä—ã –ª–∏—Å—Ç–∞ A4 –≤ –º–º
            const sheetW = 210;
            const sheetH = 297;

            // –î–æ—Å—Ç—É–ø–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ
            const availableW = sheetW - (margin * 2);
            const availableH = sheetH - (margin * 2);

            // –°–∫–æ–ª—å–∫–æ –≤–ª–µ–∑–∞–µ—Ç –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É
            const perRow = Math.floor((availableW + gap) / (w + gap));
            // –°–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ –≤–ª–µ–∑–∞–µ—Ç
            const rows = Math.floor((availableH + gap) / (h + gap));
            
            const totalCapacity = perRow * rows;

            // –°—á–∏—Ç–∞–µ–º —Å–∫–æ–ª—å–∫–æ —É–∂–µ –∑–∞–Ω—è—Ç–æ
            let currentCount = 0;
            stickerGroups.forEach(g => currentCount += g.count);

            const needed = totalCapacity - currentCount;

            if (needed > 0) {
                addStickers(needed);
            } else {
                alert("–õ–∏—Å—Ç —É–∂–µ –ø–æ–ª–æ–Ω –∏–ª–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω!");
            }
        }

        function clearSheet() {
            stickerGroups = [];
            updateLog();
            renderSheet();
        }

        function removeGroup(index) {
            stickerGroups.splice(index, 1);
            updateLog();
            renderSheet();
        }

        function toggleCutLines() {
            const sheet = document.getElementById('sheet');
            const chk = document.getElementById('showCutLines');
            if (chk.checked) sheet.classList.add('cut-lines');
            else sheet.classList.remove('cut-lines');
        }

        function updateLog() {
            const list = document.getElementById('logList');
            list.innerHTML = '';
            if (stickerGroups.length === 0) {
                list.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</div>';
                return;
            }

            stickerGroups.forEach((group, index) => {
                const item = document.createElement('div');
                item.className = 'added-item';
                
                let desc = group.text ? `"${group.text.substring(0,15)}..."` : "–ü—É—Å—Ç–∞—è / –ö–∞—Ä—Ç–∏–Ω–∫–∞";
                if (!group.text && !group.imgData) desc = "–ß–∏—Å—Ç—ã–π –±–ª–∞–Ω–∫";

                item.innerHTML = `
                    <div class="item-info">
                        <div class="color-dot" style="background:${group.bg}"></div>
                        <div>
                            <b>${group.count} —à—Ç</b> <span style="color:#888; font-size:0.75rem">(${group.width}x${group.height}–º–º)</span>
                            <br><div style="color:#555; font-size:0.75rem">${desc}</div>
                        </div>
                    </div>
                    <button onclick="removeGroup(${index})" style="border:none; background:none; cursor:pointer; color:#e74c3c; font-size:1.2rem;">&times;</button>
                `;
                list.appendChild(item);
            });
        }

        function renderSheet() {
            const sheet = document.getElementById('sheet');
            const margin = document.getElementById('pageMargin').value + 'mm';
            const gap = document.getElementById('gap').value + 'mm';
            const warning = document.getElementById('warningMsg');

            sheet.innerHTML = '';
            sheet.style.padding = margin;
            sheet.style.gap = gap;
            sheet.classList.remove('overflowed');
            warning.style.display = 'none';

            stickerGroups.forEach(group => {
                for (let i = 0; i < group.count; i++) {
                    const el = document.createElement('div');
                    el.className = 'sticker';
                    el.style.width = group.width + 'mm';
                    el.style.height = group.height + 'mm';
                    el.style.backgroundColor = group.bg;
                    el.style.border = group.border;
                    
                    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ–º
                    const content = document.createElement('div');
                    content.className = 'sticker-content';
                    content.style.justifyContent = group.align;
                    content.style.alignItems = 'center'; // –í—Å–µ–≥–¥–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏
                    
                    // –¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ (—á–µ—Ä–Ω—ã–π –∏–ª–∏ –±–µ–ª—ã–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ñ–æ–Ω–∞ - –ø—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞)
                    content.style.color = '#000'; 

                    // 1. –°–Ω–∞—á–∞–ª–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
                    if (group.imgData) {
                        const img = document.createElement('img');
                        img.src = group.imgData;
                        // –û—Ç—Å—Ç—É–ø—ã, —á—Ç–æ–±—ã –∫–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–µ –ø—Ä–∏–ª–∏–ø–∞–ª–∞ –∫ –∫—Ä–∞—è–º
                        img.style.padding = '2px';
                        content.appendChild(img);
                    }

                    // 2. –ó–∞—Ç–µ–º —Ç–µ–∫—Å—Ç (–µ—Å–ª–∏ –µ—Å—Ç—å)
                    if (group.text && group.text.trim() !== "") {
                        const span = document.createElement('span');
                        span.innerText = group.text;
                        span.style.fontSize = group.fontSize + 'px';
                        span.style.padding = '2px';
                        content.appendChild(span);
                    }

                    // –ï—Å–ª–∏ –∏ —Ç–µ–∫—Å—Ç–∞ –∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –Ω–µ—Ç ‚Äî content –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –ø—É—Å—Ç—ã–º, –Ω–∞–∫–ª–µ–π–∫–∞ –±—É–¥–µ—Ç "—á–∏—Å—Ç–æ–π"
                    el.appendChild(content);
                    sheet.appendChild(el);
                }
            });

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ (—Å –Ω–µ–±–æ–ª—å—à–∏–º –¥–æ–ø—É—Å–∫–æ–º 2px)
            if (sheet.scrollHeight > sheet.clientHeight + 2) {
                sheet.classList.add('overflowed');
                warning.style.display = 'block';
            }
        }

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        updateLog();
    </script>
</body>
</html>
